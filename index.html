<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Language Vocabulary Practice</title>
  <!-- Chart.js CDN for Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #1a1a1a;
      --secondary: #dd0000;
      --accent: #ffcc00;
      --background: #f5f5f5;
      --text: #333333;
      --modal-bg: rgba(0, 0, 0, 0.5);
      --modal-content-bg: #ffffff;
      --success-color: #4CAF50;
      --error-color: #F44336;
      --progress-bg: #ddd;
      --progress-bar: #4CAF50;
      --badge-bg: #ff5722;
      --badge-text: #ffffff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }

    body {
      background-color: var(--background);
      color: var(--text);
      line-height: 1.6;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background-color: var(--primary);
      color: white;
      padding: 1rem;
      text-align: center;
      margin-bottom: 2rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .nav-breadcrumb {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .nav-breadcrumb a {
      color: var(--secondary);
      text-decoration: none;
    }

    .nav-breadcrumb a:hover {
      text-decoration: underline;
    }

    .stats {
      display: flex;
      justify-content: space-around;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .stat-card {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      flex: 1;
      min-width: 200px;
      text-align: center;
    }

    .card {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }

    .language-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .language-card {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      text-align: center;
      cursor: pointer;
      transition: transform 0.2s;
      position: relative;
    }

    .language-card:hover {
      transform: translateY(-5px);
    }

    .reset-app-btn {
      background-color: #555;
      margin-top: 1rem;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 0.8rem;
      margin-bottom: 1rem;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    button {
      background-color: var(--secondary);
      color: white;
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #bb0000;
    }

    .options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .option {
      padding: 1rem;
      border: 2px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .option:hover {
      border-color: var(--accent);
    }

    .option.correct {
      border-color: var(--success-color);
      background-color: #E8F5E9;
    }

    .option.wrong {
      border-color: var(--error-color);
      background-color: #FFEBEE;
    }

    .result {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 4px;
      text-align: center;
    }

    .word-list {
      margin-top: 1rem;
    }

    .word-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem;
      border-bottom: 1px solid #ddd;
    }

    .word-item-content {
      flex-grow: 1;
      margin-right: 1rem;
    }

    .tag-input {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .tag-input input {
      flex-grow: 1;
    }

    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin: 0.5rem 0;
    }

    .tag {
      background: var(--accent);
      color: var(--primary);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .tag button {
      background: none;
      border: none;
      color: var(--primary);
      padding: 0;
      font-size: 1.2rem;
      line-height: 1;
      cursor: pointer;
    }

    .tag-filter {
      margin-bottom: 1rem;
    }

    .word-tags {
      margin-top: 0.3rem;
      font-size: 0.9rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .word-notes {
      margin-top: 0.3rem;
      font-size: 0.9rem;
      color: #555;
      font-style: italic;
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .action-buttons button {
      padding: 0.3rem 0.6rem;
      font-size: 0.8rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      color: white;
      transition: background-color 0.3s;
    }

    .action-buttons button.edit-btn {
      background-color: #4CAF50;
    }

    .action-buttons button.edit-btn:hover {
      background-color: #45a049;
    }

    .action-buttons button.delete-btn {
      background-color: var(--error-color);
    }

    .action-buttons button.delete-btn:hover {
      background-color: #d32f2f;
    }

    /* Badge Styles */
    .badge {
      background-color: var(--badge-bg);
      color: var(--badge-text);
      padding: 0.3rem 0.6rem;
      border-radius: 12px;
      font-size: 0.8rem;
      margin-right: 0.5rem;
      display: inline-block;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: var(--modal-bg);
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .modal-content {
      background-color: var(--modal-content-bg);
      margin: auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 600px;
      border-radius: 8px;
      position: relative;
      animation: slideIn 0.3s;
    }

    @keyframes slideIn {
      from {
        transform: translateY(-50px);
      }

      to {
        transform: translateY(0);
      }
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      position: absolute;
      top: 10px;
      right: 20px;
      cursor: pointer;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
    }

    .modal-header {
      margin-bottom: 1rem;
    }

    .modal-header h2 {
      margin: 0;
    }

    .modal-footer {
      margin-top: 1rem;
      text-align: right;
    }

    .modal-footer button {
      margin-left: 0.5rem;
    }

    /* Quiz Modal Specific Styles */
    .quiz-progress {
      width: 100%;
      background-color: var(--progress-bg);
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 1rem;
    }

    .quiz-progress-bar {
      height: 20px;
      width: 0%;
      background-color: var(--progress-bar);
      transition: width 0.3s;
    }

    /* Responsive Enhancements */
    @media (max-width: 800px) {
      .stats {
        flex-direction: column;
      }
    }

    @media (max-width: 600px) {
      .container {
        padding: 10px;
      }

      .card {
        padding: 1rem;
      }

      .options {
        grid-template-columns: 1fr;
      }

      .modal-content {
        width: 95%;
      }

      .action-buttons {
        flex-direction: column;
        align-items: flex-start;
      }

      .action-buttons button {
        width: 100%;
      }

      .stats {
        flex-direction: column;
        align-items: stretch;
      }

      .stat-card {
        margin-bottom: 1rem;
      }
    }

    /* Search Bar Styles */
    .search-bar {
      margin-bottom: 1rem;
      display: flex;
      gap: 0.5rem;
    }

    .search-bar input {
      flex-grow: 1;
    }

    /* Badge Container */
    .badge-container {
      margin-top: 1rem;
    }

    /* Language Notes Card */
    .language-notes {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .language-notes textarea {
      width: 100%;
      min-height: 80px;
      resize: vertical;
    }
  </style>
</head>

<body>
  <header>
    <svg width="50" height="50" viewBox="0 0 100 100">
      <circle cx="50" cy="50" r="45" fill="var(--secondary)"></circle>
      <path d="M30 40 L50 60 L70 40" fill="none" stroke="white" stroke-width="6"></path>
      <text x="50" y="75" text-anchor="middle" fill="white" style="font-size: 24px;">L</text>
    </svg>
    <h1>Language Learning</h1>
  </header>

  <div class="container">
    <div id="breadcrumb" class="nav-breadcrumb">
      <a href="#" onclick="showMainMenu()">Home</a>
    </div>

    <!-- Main Menu -->
    <div id="mainMenu">
      <div class="card">
        <h2>Add New Language</h2>
        <input type="text" id="newLanguage" placeholder="Language Name" />
        <button onclick="addLanguage()">Add Language</button>
        <button class="reset-app-btn" onclick="openResetAppModal()">Reset All Data</button>
        <button onclick="exportData()" style="background-color: var(--accent); margin-top: 0.5rem;">
          Export Data
        </button>
        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)" />
        <button onclick="document.getElementById('importFile').click()"
          style="background-color: var(--accent); margin-top: 0.5rem;">
          Import Data
        </button>
      </div>

      <div class="card">
        <h2>Your Languages</h2>
        <div id="languageGrid" class="language-grid"></div>
      </div>
    </div>

    <!-- Language View -->
    <div id="languageView" style="display: none;">
      <div class="stats">
        <div class="stat-card">
          <h3>Total Words</h3>
          <p id="totalWords">0</p>
        </div>
        <div class="stat-card">
          <h3>Today's Score</h3>
          <p id="todayScore">0%</p>
        </div>
        <div class="stat-card">
          <h3>Total Practice Sessions</h3>
          <p id="totalSessions">0</p>
        </div>
        <div class="stat-card">
          <h3>Average Score</h3>
          <p id="averageScore">0%</p>
        </div>
        <div class="stat-card">
          <h3>Category Accuracy</h3>
          <div id="categoryAccuracy"></div>
        </div>
        <div class="stat-card">
          <h3>Streak</h3>
          <p id="streak">0 days</p>
        </div>
        <div class="stat-card">
          <h3>Badges</h3>
          <div id="badges" class="badge-container"></div>
        </div>
      </div>

      <!-- Language Notes Card -->
      <div class="card">
        <h2>Language Notes</h2>
        <div class="language-notes">
          <textarea id="languageNotes" placeholder="Enter reference notes for this language..."></textarea>
          <button onclick="saveLanguageNotes()">Save Notes</button>
        </div>
      </div>

      <div class="card">
        <h2>Add New Word</h2>
        <input type="text" id="foreignWord" placeholder="Foreign Word" />
        <input type="text" id="englishWord" placeholder="English Translation" />
        <div class="tag-input">
          <input type="text" id="wordTags" placeholder="Tags (comma-separated)" list="tagSuggestions" />
          <datalist id="tagSuggestions"></datalist>
        </div>
        <textarea id="wordNotes" placeholder="Personal Notes (optional)" rows="3"></textarea>
        <button onclick="addWord()">Add Word</button>
      </div>

      <div class="card">
        <h2>Word List</h2>
        <div class="search-bar">
          <input type="text" id="searchWord" placeholder="Search Words..." oninput="updateWordList()" />
          <button onclick="clearSearch()">Clear</button>
        </div>
        <div class="tag-filter">
          <select id="tagFilter" onchange="updateWordList()">
            <option value="">All Tags</option>
          </select>
        </div>
        <div id="wordList" class="word-list"></div>
      </div>

      <div class="card">
        <h2>Practice</h2>
        <div class="tag-filter">
          <select id="practiceTagFilter">
            <option value="">All Tags</option>
          </select>
        </div>
        <select id="practiceMode">
          <option value="mcq">Multiple Choice</option>
          <option value="translate">Translation</option>
          <option value="both">Bidirectional</option>
        </select>
        <button onclick="openQuizModal()">Start Practice</button>
      </div>

      <div class="card">
        <h2>Statistics Charts</h2>
        <canvas id="accuracyChart" width="400" height="200"></canvas>
        <canvas id="categoryChart" width="400" height="200"></canvas>
      </div>

      <button class="reset-app-btn" style="background-color: var(--error-color);" onclick="openResetLanguageModal()">
        Reset Language Data
      </button>
    </div>
  </div>

  <!-- Edit Word Modal -->
  <div id="editWordModal" class="modal" style="display: none;" inert>
    <div class="modal-content" role="dialog" id="editWordTitle">
      <span class="close" onclick="closeEditWordModal()">&times;</span>
      <div class="modal-header">
        <h2>Edit Word</h2>
      </div>
      <div class="modal-body">
        <input type="text" id="editForeignWord" placeholder="Foreign Word" />
        <input type="text" id="editEnglishWord" placeholder="English Translation" />
        <div class="tag-input">
          <input type="text" id="editWordTags" placeholder="Tags (comma-separated)" list="editTagSuggestions" />
          <datalist id="editTagSuggestions"></datalist>
        </div>
        <textarea id="editWordNotes" placeholder="Personal Notes (optional)" rows="3"></textarea>
      </div>
      <div class="modal-footer">
        <button onclick="saveEditedWord()">Save</button>
        <button onclick="closeEditWordModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Reset App Modal -->
  <div id="resetAppModal" class="modal" style="display: none;" inert>
    <div class="modal-content" role="dialog" id="resetAppTitle">
      <span class="close" onclick="closeResetAppModal()">&times;</span>
      <div class="modal-header">
        <h2>Reset All Data</h2>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to reset all data? This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button onclick="resetApp()">Yes, Reset All</button>
        <button onclick="closeResetAppModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Reset Language Modal -->
  <div id="resetLanguageModal" class="modal" style="display: none;" inert>
    <div class="modal-content" role="dialog" id="resetLanguageTitle">
      <span class="close" onclick="closeResetLanguageModal()">&times;</span>
      <div class="modal-header">
        <h2>Reset Language Data</h2>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to reset all data for the language "<span id="languageToReset"></span>"? This action
          cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button onclick="resetLanguage()">Yes, Reset Language</button>
        <button onclick="closeResetLanguageModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Alert Modal -->
  <div id="alertModal" class="modal" style="display: none;" inert>
    <div class="modal-content" role="alertdialog" id="alertTitle">
      <span class="close" onclick="closeAlertModal()">&times;</span>
      <div class="modal-header">
        <h2>Alert</h2>
      </div>
      <div class="modal-body">
        <p id="alertMessage"></p>
      </div>
      <div class="modal-footer">
        <button onclick="closeAlertModal()">OK</button>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="successModal" class="modal" style="display: none;" inert>
    <div class="modal-content" role="alertdialog" id="successTitle">
      <span class="close" onclick="closeSuccessModal()">&times;</span>
      <div class="modal-header">
        <h2>Success</h2>
      </div>
      <div class="modal-body">
        <p id="successMessage"></p>
      </div>
      <div class="modal-footer">
        <button onclick="closeSuccessModal()">OK</button>
      </div>
    </div>
  </div>

  <!-- Quiz Modal -->
  <div id="quizModal" class="modal" style="display: none;" inert>
    <div class="modal-content" role="dialog" id="quizTitle">
      <span class="close" onclick="closeQuizModal()">&times;</span>
      <div class="modal-header">
        <h2>Practice Quiz</h2>
      </div>
      <div class="modal-body">
        <div class="quiz-progress">
          <div class="quiz-progress-bar" id="quizProgressBar"></div>
        </div>
        <p id="quizProgressText">Question 1 of 10</p>
        <h3 id="quizQuestion">Question text here</h3>
        <div id="quizAnswerContainer"></div>
        <div id="quizResult" class="result"></div>
      </div>
      <div class="modal-footer">
        <button onclick="endQuiz()">End Quiz</button>
      </div>
    </div>
  </div>

  <script>
    /* =====================================================
       JAVASCRIPT CODE FOR MULTI-PAGE-LIKE UI & FEATURES
       ===================================================== */

    // Global variables
    let currentLanguage = '';
    let currentQuestion = 0;
    let score = 0;
    let totalQuestions = 0;
    let practiceWords = [];
    let editingWordIndex = null;
    let quizCategoryStats = {};
    let focusedElementBeforeModal = null;
    let accuracyChartInstance = null;
    let categoryChartInstance = null;

    // Initialize localStorage if empty
    if (!localStorage.getItem('languages')) {
      localStorage.setItem('languages', JSON.stringify({}));
    }
    // We'll store tag colors in localStorage as well, to keep them consistent
    if (!localStorage.getItem('tagColors')) {
      localStorage.setItem('tagColors', JSON.stringify({}));
    }

    // ========== Utility Functions ==========

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function closeAllModals() {
      const modals = document.querySelectorAll('.modal');
      modals.forEach((modal) => {
        modal.style.display = 'none';
        modal.setAttribute('inert', '');
      });
      releaseFocus();
    }

    // Random pastel color generator for tags
    function getRandomPastelColor() {
      const hue = Math.floor(Math.random() * 360);
      return `hsl(${hue}, 70%, 85%)`;
    }

    // Assign a color to each tag, store in localStorage for consistency
    function getTagColor(tag) {
      let tagColors = JSON.parse(localStorage.getItem('tagColors'));
      if (!tagColors[tag]) {
        tagColors[tag] = getRandomPastelColor();
        localStorage.setItem('tagColors', JSON.stringify(tagColors));
      }
      return tagColors[tag];
    }

    // ========== Modal Focus Management ==========

    function trapFocus(modalId) {
      const modal = document.getElementById(modalId);
      modal.removeAttribute('inert');
      const focusableElementsString =
        'a[href], area[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), iframe, object, embed, [tabindex="0"], [contenteditable]';

      const focusableElements = modal.querySelectorAll(focusableElementsString);
      if (focusableElements.length === 0) return;

      const firstTabStop = focusableElements[0];
      const lastTabStop = focusableElements[focusableElements.length - 1];

      focusedElementBeforeModal = document.activeElement;
      firstTabStop.focus();

      modal.addEventListener('keydown', function (e) {
        if (e.key === 'Tab') {
          if (e.shiftKey) {
            if (document.activeElement === firstTabStop) {
              e.preventDefault();
              lastTabStop.focus();
            }
          } else {
            if (document.activeElement === lastTabStop) {
              e.preventDefault();
              firstTabStop.focus();
            }
          }
        }
        if (e.key === 'Escape') {
          closeAllModals();
        }
      });
    }

    function releaseFocus() {
      if (focusedElementBeforeModal) {
        focusedElementBeforeModal.focus();
      }
    }

    // ========== Main Menu Functions ==========

    function showMainMenu() {
      document.getElementById('mainMenu').style.display = 'block';
      document.getElementById('languageView').style.display = 'none';
      document.getElementById('breadcrumb').innerHTML =
        '<a href="#" onclick="showMainMenu()">Home</a>';
      updateLanguageGrid();
    }

    function addLanguage() {
      const languageName = document.getElementById('newLanguage').value.trim();
      if (!languageName) {
        openAlertModal('Please enter a language name.');
        return;
      }

      const languages = JSON.parse(localStorage.getItem('languages'));
      if (languages[languageName]) {
        openAlertModal('This language already exists.');
        return;
      }

      languages[languageName] = {
        words: [],
        stats: {
          todayScore: 0,
          lastPractice: null,
          totalSessions: 0,
          totalScore: 0,
          categoryStats: {},
          streak: 0,
          badges: [],
          practiceDates: [],
          practiceScores: [],
          languageNotes: '' // We'll store language-level notes here
        },
      };
      localStorage.setItem('languages', JSON.stringify(languages));
      document.getElementById('newLanguage').value = '';
      updateLanguageGrid();
      openSuccessModal(`Language "${languageName}" added successfully.`);
    }

    function updateLanguageGrid() {
      const languages = JSON.parse(localStorage.getItem('languages'));
      const grid = document.getElementById('languageGrid');
      grid.innerHTML = '';

      if (Object.keys(languages).length === 0) {
        grid.innerHTML = '<p>No languages added yet.</p>';
        return;
      }

      Object.keys(languages).forEach((lang) => {
        const card = document.createElement('div');
        card.className = 'language-card';
        card.innerHTML = `
          <h3>${lang}</h3>
          <p>${languages[lang].words.length} words</p>
        `;
        card.onclick = () => openLanguage(lang);
        grid.appendChild(card);
      });
    }

    // ========== Language View ==========

    function openLanguage(language) {
      currentLanguage = language;
      document.getElementById('mainMenu').style.display = 'none';
      document.getElementById('languageView').style.display = 'block';
      document.getElementById('breadcrumb').innerHTML = `
        <a href="#" onclick="showMainMenu()">Home</a> > ${language}
      `;
      updateStats();
      updateWordList();
      updateTagFilters();
      populatePracticeTagFilter();
      updateTagSuggestions();
      updateEditTagSuggestions();
      updateBadges();
      loadLanguageNotes(); // load any existing notes for this language
    }

    // ========== Language Notes ==========

    function loadLanguageNotes() {
      const languages = JSON.parse(localStorage.getItem('languages'));
      const notes = languages[currentLanguage].stats.languageNotes || '';
      document.getElementById('languageNotes').value = notes;
    }

    function saveLanguageNotes() {
      const notesVal = document.getElementById('languageNotes').value.trim();
      const languages = JSON.parse(localStorage.getItem('languages'));
      languages[currentLanguage].stats.languageNotes = notesVal;
      localStorage.setItem('languages', JSON.stringify(languages));
      openSuccessModal('Language notes saved successfully.');
    }

    // ========== Word Management ==========

    function addWord() {
      const foreignWord = document.getElementById('foreignWord').value.trim();
      const englishWord = document.getElementById('englishWord').value.trim();
      const tags = document
        .getElementById('wordTags')
        .value.split(',')
        .map((t) => t.trim())
        .filter((t) => t.length > 0);
      const notes = document.getElementById('wordNotes').value.trim();

      if (!foreignWord || !englishWord) {
        openAlertModal(
          'Please enter both the foreign word and its English translation.'
        );
        return;
      }

      const languages = JSON.parse(localStorage.getItem('languages'));
      languages[currentLanguage].words.push({
        foreign: foreignWord,
        english: englishWord,
        tags,
        notes,
        date: new Date().toISOString(),
      });
      localStorage.setItem('languages', JSON.stringify(languages));

      // Clear inputs
      document.getElementById('foreignWord').value = '';
      document.getElementById('englishWord').value = '';
      document.getElementById('wordTags').value = '';
      document.getElementById('wordNotes').value = '';

      updateStats();
      updateWordList();
      updateTagFilters();
      populatePracticeTagFilter();
      updateTagSuggestions();
      updateEditTagSuggestions();
      openSuccessModal(`Word "${foreignWord}" added successfully.`);
    }

    function updateWordList() {
      const languages = JSON.parse(localStorage.getItem('languages'));
      const words = languages[currentLanguage].words;
      const listElement = document.getElementById('wordList');
      const selectedTag = document.getElementById('tagFilter').value;
      const searchTerm = document
        .getElementById('searchWord')
        .value.trim()
        .toLowerCase();

      listElement.innerHTML = '';

      // Filter words by tag and search term
      const filteredWords = words.filter((word) => {
        const matchesTag = selectedTag ? word.tags.includes(selectedTag) : true;
        const matchesSearch =
          searchTerm.length > 0
            ? word.foreign.toLowerCase().includes(searchTerm) ||
            word.english.toLowerCase().includes(searchTerm)
            : true;
        return matchesTag && matchesSearch;
      });

      if (filteredWords.length === 0) {
        listElement.innerHTML = '<p>No words to display.</p>';
        return;
      }

      filteredWords.forEach((word) => {
        const actualIndex = languages[currentLanguage].words.indexOf(word);
        const item = document.createElement('div');
        item.className = 'word-item';

        const content = document.createElement('div');
        content.className = 'word-item-content';
        content.innerHTML = `
          <div><strong>${word.foreign}</strong> - ${word.english}</div>
          <div class="word-tags">
            ${word.tags
            .map(
              (tag) => `
              <span class="tag" style="background: ${getTagColor(tag)};">
                ${tag}
                <button onclick="removeTag(${actualIndex}, '${tag}')">&times;</button>
              </span>
            `
            )
            .join('')}
          </div>
          <div class="word-notes">
            ${word.notes ? word.notes : 'No notes.'}
          </div>
        `;

        const actionButtons = document.createElement('div');
        actionButtons.className = 'action-buttons';

        const editButton = document.createElement('button');
        editButton.textContent = 'Edit';
        editButton.className = 'edit-btn';
        editButton.onclick = () => openEditWordModal(actualIndex);
        actionButtons.appendChild(editButton);

        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Delete';
        deleteButton.className = 'delete-btn';
        deleteButton.onclick = () => deleteWord(actualIndex);
        actionButtons.appendChild(deleteButton);

        item.appendChild(content);
        item.appendChild(actionButtons);
        listElement.appendChild(item);
      });
    }

    function removeTag(wordIndex, tag) {
      const languages = JSON.parse(localStorage.getItem('languages'));
      const word = languages[currentLanguage].words[wordIndex];
      word.tags = word.tags.filter((t) => t !== tag);
      localStorage.setItem('languages', JSON.stringify(languages));

      updateWordList();
      updateTagFilters();
      populatePracticeTagFilter();
      updateTagSuggestions();
      updateEditTagSuggestions();
      openSuccessModal(`Tag "${tag}" removed from the word.`);
    }

    function deleteWord(wordIndex) {
      if (!confirm('Are you sure you want to delete this word?')) return;
      const languages = JSON.parse(localStorage.getItem('languages'));
      const word = languages[currentLanguage].words[wordIndex];
      languages[currentLanguage].words.splice(wordIndex, 1);
      localStorage.setItem('languages', JSON.stringify(languages));

      updateStats();
      updateWordList();
      updateTagFilters();
      populatePracticeTagFilter();
      updateTagSuggestions();
      updateEditTagSuggestions();
      openSuccessModal(`Word "${word.foreign}" deleted successfully.`);
    }

    // ========== Tag Handling ==========

    function updateTagFilters() {
      const languages = JSON.parse(localStorage.getItem('languages'));
      const words = languages[currentLanguage].words;
      const allTags = new Set();

      words.forEach((word) => {
        word.tags.forEach((tag) => allTags.add(tag));
      });

      const tagFilter = document.getElementById('tagFilter');
      const currentValue = tagFilter.value;
      tagFilter.innerHTML = '<option value="">All Tags</option>';

      Array.from(allTags)
        .sort()
        .forEach((tag) => {
          const option = document.createElement('option');
          option.value = tag;
          option.textContent = tag;
          tagFilter.appendChild(option);
        });

      tagFilter.value = currentValue;
    }

    function populatePracticeTagFilter() {
      const languages = JSON.parse(localStorage.getItem('languages'));
      const words = languages[currentLanguage].words;
      const allTags = new Set();

      words.forEach((word) => {
        word.tags.forEach((tag) => allTags.add(tag));
      });

      const practiceTagFilter = document.getElementById('practiceTagFilter');
      const currentValue = practiceTagFilter.value;
      practiceTagFilter.innerHTML = '<option value="">All Tags</option>';

      Array.from(allTags)
        .sort()
        .forEach((tag) => {
          const option = document.createElement('option');
          option.value = tag;
          option.textContent = tag;
          practiceTagFilter.appendChild(option);
        });

      practiceTagFilter.value = currentValue;
    }

    function updateTagSuggestions() {
      const languages = JSON.parse(localStorage.getItem('languages'));
      const words = languages[currentLanguage].words;
      const allTags = new Set();

      words.forEach((word) => {
        word.tags.forEach((tag) => allTags.add(tag));
      });

      const tagSuggestions = document.getElementById('tagSuggestions');
      tagSuggestions.innerHTML = '';

      Array.from(allTags)
        .sort()
        .forEach((tag) => {
          const option = document.createElement('option');
          option.value = tag;
          tagSuggestions.appendChild(option);
        });
    }

    function updateEditTagSuggestions() {
      const languages = JSON.parse(localStorage.getItem('languages'));
      const words = languages[currentLanguage].words;
      const allTags = new Set();

      words.forEach((word) => {
        word.tags.forEach((tag) => allTags.add(tag));
      });

      const editTagSuggestions = document.getElementById('editTagSuggestions');
      editTagSuggestions.innerHTML = '';

      Array.from(allTags)
        .sort()
        .forEach((tag) => {
          const option = document.createElement('option');
          option.value = tag;
          editTagSuggestions.appendChild(option);
        });
    }

    // ========== Edit Word Modal ==========

    function openEditWordModal(wordIndex) {
      editingWordIndex = wordIndex;
      const languages = JSON.parse(localStorage.getItem('languages'));
      const word = languages[currentLanguage].words[wordIndex];

      document.getElementById('editForeignWord').value = word.foreign;
      document.getElementById('editEnglishWord').value = word.english;
      document.getElementById('editWordTags').value = word.tags.join(', ');
      document.getElementById('editWordNotes').value = word.notes || '';
      const modal = document.getElementById('editWordModal');
      modal.style.display = 'flex';
      trapFocus('editWordModal');
    }

    function closeEditWordModal() {
      editingWordIndex = null;
      const modal = document.getElementById('editWordModal');
      modal.style.display = 'none';
      modal.setAttribute('inert', '');
      releaseFocus();
    }

    function saveEditedWord() {
      const foreignWord = document.getElementById('editForeignWord').value.trim();
      const englishWord = document.getElementById('editEnglishWord').value.trim();
      const tags = document
        .getElementById('editWordTags')
        .value.split(',')
        .map((t) => t.trim())
        .filter((t) => t.length > 0);
      const notes = document.getElementById('editWordNotes').value.trim();

      if (!foreignWord || !englishWord) {
        openAlertModal('Foreign word and English translation cannot be empty.');
        return;
      }

      const languages = JSON.parse(localStorage.getItem('languages'));
      languages[currentLanguage].words[editingWordIndex] = {
        foreign: foreignWord,
        english: englishWord,
        tags,
        notes,
        date: languages[currentLanguage].words[editingWordIndex].date,
      };
      localStorage.setItem('languages', JSON.stringify(languages));

      closeEditWordModal();
      updateWordList();
      updateTagFilters();
      populatePracticeTagFilter();
      updateTagSuggestions();
      updateEditTagSuggestions();
      openSuccessModal(`Word "${foreignWord}" updated successfully.`);
    }

    // ========== Reset App Modal Functions ==========

    function openResetAppModal() {
      const modal = document.getElementById('resetAppModal');
      modal.style.display = 'flex';
      trapFocus('resetAppModal');
    }

    function closeResetAppModal() {
      const modal = document.getElementById('resetAppModal');
      modal.style.display = 'none';
      modal.setAttribute('inert', '');
      releaseFocus();
    }

    function openResetLanguageModal() {
      document.getElementById('languageToReset').textContent = currentLanguage;
      const modal = document.getElementById('resetLanguageModal');
      modal.style.display = 'flex';
      trapFocus('resetLanguageModal');
    }

    function closeResetLanguageModal() {
      const modal = document.getElementById('resetLanguageModal');
      modal.style.display = 'none';
      modal.setAttribute('inert', '');
      releaseFocus();
    }

    // ========== Alert & Success Modals ==========

    function openAlertModal(message) {
      document.getElementById('alertMessage').textContent = message;
      const modal = document.getElementById('alertModal');
      modal.style.display = 'flex';
      trapFocus('alertModal');
    }

    function closeAlertModal() {
      const modal = document.getElementById('alertModal');
      modal.style.display = 'none';
      modal.setAttribute('inert', '');
      releaseFocus();
    }

    function openSuccessModal(message) {
      document.getElementById('successMessage').textContent = message;
      const modal = document.getElementById('successModal');
      modal.style.display = 'flex';
      trapFocus('successModal');
    }

    function closeSuccessModal() {
      const modal = document.getElementById('successModal');
      modal.style.display = 'none';
      modal.setAttribute('inert', '');
      releaseFocus();
    }

    // ========== Reset Functions ==========

    function resetApp() {
      localStorage.removeItem('languages');
      localStorage.setItem('languages', JSON.stringify({}));
      localStorage.removeItem('tagColors');
      showMainMenu();
      closeResetAppModal();
      openSuccessModal('All data has been reset.');
    }

    function resetLanguage() {
      const languages = JSON.parse(localStorage.getItem('languages'));
      languages[currentLanguage] = {
        words: [],
        stats: {
          todayScore: 0,
          lastPractice: null,
          totalSessions: 0,
          totalScore: 0,
          categoryStats: {},
          streak: 0,
          badges: [],
          practiceDates: [],
          practiceScores: [],
          languageNotes: ''
        },
      };
      localStorage.setItem('languages', JSON.stringify(languages));

      updateStats();
      updateWordList();
      updateTagFilters();
      populatePracticeTagFilter();
      updateTagSuggestions();
      updateEditTagSuggestions();
      updateBadges();
      closeResetLanguageModal();
      openSuccessModal(
        `All data for the language "${currentLanguage}" has been reset.`
      );
    }

    // ========== Export / Import Data ==========

    function exportData() {
      const languages = JSON.parse(localStorage.getItem('languages'));
      const dataStr =
        'data:text/json;charset=utf-8,' +
        encodeURIComponent(JSON.stringify(languages, null, 2));
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute('href', dataStr);
      downloadAnchorNode.setAttribute('download', 'language_data.json');
      document.body.appendChild(downloadAnchorNode);
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const importedData = JSON.parse(e.target.result);
          const languages = JSON.parse(localStorage.getItem('languages'));

          // Merge imported data
          for (const [lang, data] of Object.entries(importedData)) {
            if (languages[lang]) {
              // Merge words
              languages[lang].words = languages[lang].words.concat(data.words);

              // Merge stats
              languages[lang].stats.totalSessions += data.stats.totalSessions;
              languages[lang].stats.totalScore += data.stats.totalScore;

              for (const [category, stats] of Object.entries(
                data.stats.categoryStats
              )) {
                if (!languages[lang].stats.categoryStats[category]) {
                  languages[lang].stats.categoryStats[category] = {
                    correct: 0,
                    total: 0,
                  };
                }
                languages[lang].stats.categoryStats[category].correct +=
                  stats.correct;
                languages[lang].stats.categoryStats[category].total +=
                  stats.total;
              }

              // Merge streak
              if (data.stats.streak) {
                languages[lang].stats.streak += data.stats.streak;
              }

              // Merge badges
              languages[lang].stats.badges = Array.from(
                new Set([...languages[lang].stats.badges, ...data.stats.badges])
              );

              // Merge language-level notes
              if (data.stats.languageNotes) {
                languages[lang].stats.languageNotes =
                  data.stats.languageNotes +
                  '\n' +
                  (languages[lang].stats.languageNotes || '');
              }

              // Merge practiceDates and practiceScores
              if (data.stats.practiceDates && data.stats.practiceScores) {
                languages[lang].stats.practiceDates =
                  languages[lang].stats.practiceDates.concat(
                    data.stats.practiceDates
                  );
                languages[lang].stats.practiceScores =
                  languages[lang].stats.practiceScores.concat(
                    data.stats.practiceScores
                  );
              }
            } else {
              languages[lang] = data;
            }
          }

          localStorage.setItem('languages', JSON.stringify(languages));
          if (currentLanguage) {
            updateStats();
            updateWordList();
            updateTagFilters();
            populatePracticeTagFilter();
            updateTagSuggestions();
            updateEditTagSuggestions();
            updateBadges();
            loadLanguageNotes();
          }
          openSuccessModal('Data imported successfully.');
        } catch (error) {
          openAlertModal(
            'Failed to import data. Please ensure the file is valid JSON.'
          );
        }
      };
      reader.readAsText(file);
    }

    // ========== Stats & Badges ==========

    function updateStats() {
      const languages = JSON.parse(localStorage.getItem('languages'));
      const language = languages[currentLanguage];
      document.getElementById('totalWords').textContent = language.words.length;

      const now = new Date();

      // Streak logic
      if (language.stats.lastPractice) {
        const lastPracticeDate = new Date(language.stats.lastPractice);
        const diffTime = now - lastPracticeDate;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        if (diffDays === 0) {
          // same day
        } else if (diffDays === 1) {
          language.stats.streak += 1;
        } else if (diffDays > 1) {
          language.stats.streak = 1;
        }
      } else {
        language.stats.streak = 1;
      }
      document.getElementById('streak').textContent = `${language.stats.streak} days`;

      // Today's score
      if (
        language.stats.lastPractice &&
        new Date(language.stats.lastPractice).toDateString() === now.toDateString()
      ) {
        document.getElementById('todayScore').textContent = `${language.stats.todayScore}%`;
      } else {
        language.stats.todayScore = 0;
        document.getElementById('todayScore').textContent = '0%';
      }

      // Total sessions
      document.getElementById('totalSessions').textContent =
        language.stats.totalSessions;

      // Average score
      const avg =
        language.stats.totalSessions > 0
          ? Math.round(language.stats.totalScore / language.stats.totalSessions)
          : 0;
      document.getElementById('averageScore').textContent = `${avg}%`;

      // Category accuracy
      const categoryAccuracyDiv = document.getElementById('categoryAccuracy');
      categoryAccuracyDiv.innerHTML = '';
      const categories = Object.keys(language.stats.categoryStats);
      if (categories.length === 0) {
        categoryAccuracyDiv.innerHTML = '<p>No category statistics available.</p>';
      } else {
        categories.forEach((category) => {
          const {correct, total} = language.stats.categoryStats[category];
          const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
          const categoryDiv = document.createElement('div');
          categoryDiv.style.marginBottom = '0.5rem';
          categoryDiv.innerHTML = `
            <strong>${category}:</strong> ${accuracy}% (${correct}/${total})
          `;
          categoryAccuracyDiv.appendChild(categoryDiv);
        });
      }

      localStorage.setItem('languages', JSON.stringify(languages));

      // Update charts
      updateAccuracyChart();
      updateCategoryChart();
      updateBadges();
    }

    function checkForBadges(language) {
      const allLanguages = JSON.parse(localStorage.getItem('languages'));

      const badgesToCheck = [
        {name: 'First Practice', condition: language.stats.totalSessions === 1},
        {name: '100 Words', condition: language.words.length >= 100},
        {name: 'Consistent Learner', condition: language.stats.streak >= 7},
        {name: 'High Accuracy', condition: language.stats.todayScore >= 90},
        {name: 'Master', condition: language.stats.averageScore >= 90},
      ];

      badgesToCheck.forEach((badge) => {
        if (badge.condition && !language.stats.badges.includes(badge.name)) {
          language.stats.badges.push(badge.name);
          openSuccessModal(`Congratulations! You've earned the "${badge.name}" badge!`);
        }
      });

      allLanguages[currentLanguage] = language;
      localStorage.setItem('languages', JSON.stringify(allLanguages));
    }

    function updateBadges() {
      const languages = JSON.parse(localStorage.getItem('languages'));
      const language = languages[currentLanguage];
      const badgesContainer = document.getElementById('badges');
      badgesContainer.innerHTML = '';

      if (language.stats.badges.length === 0) {
        badgesContainer.innerHTML = '<p>No badges earned yet.</p>';
        return;
      }

      language.stats.badges.forEach((badge) => {
        const badgeElem = document.createElement('span');
        badgeElem.className = 'badge';
        badgeElem.textContent = badge;
        badgesContainer.appendChild(badgeElem);
      });
    }

    // ========== Chart Functions ==========

    function updateAccuracyChart() {
      const languages = JSON.parse(localStorage.getItem('languages'));
      const language = languages[currentLanguage];
      const ctx = document.getElementById('accuracyChart').getContext('2d');

      if (accuracyChartInstance) accuracyChartInstance.destroy();

      if (!language.stats.practiceDates) {
        language.stats.practiceDates = [];
        language.stats.practiceScores = [];
      }

      accuracyChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: language.stats.practiceDates,
          datasets: [
            {
              label: 'Accuracy (%)',
              data: language.stats.practiceScores,
              backgroundColor: 'rgba(76, 175, 80, 0.2)',
              borderColor: 'rgba(76, 175, 80, 1)',
              borderWidth: 1,
              fill: true,
              tension: 0.4,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              mode: 'index',
              intersect: false,
            },
            legend: {
              display: true,
              position: 'top',
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
            },
          },
        },
      });
    }

    function updateCategoryChart() {
      const languages = JSON.parse(localStorage.getItem('languages'));
      const language = languages[currentLanguage];
      const ctx = document.getElementById('categoryChart').getContext('2d');

      if (categoryChartInstance) categoryChartInstance.destroy();

      const categories = Object.keys(language.stats.categoryStats);
      const correct = categories.map(
        (cat) => language.stats.categoryStats[cat].correct
      );
      const total = categories.map(
        (cat) => language.stats.categoryStats[cat].total
      );
      const accuracy = categories.map((cat, idx) =>
        total[idx] > 0
          ? Math.round((correct[idx] / total[idx]) * 100)
          : 0
      );

      categoryChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: categories,
          datasets: [
            {
              label: 'Accuracy (%)',
              data: accuracy,
              backgroundColor: 'rgba(33, 150, 243, 0.6)',
              borderColor: 'rgba(33, 150, 243, 1)',
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              mode: 'index',
              intersect: false,
            },
            legend: {
              display: false,
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
            },
          },
        },
      });
    }

    // ========== Quiz Functions ==========

    let quizMode = 'mcq';

    function openQuizModal() {
      const languages = JSON.parse(localStorage.getItem('languages'));
      let words = languages[currentLanguage].words;

      if (words.length < 2) {
        openAlertModal('Add at least two words to start practicing.');
        return;
      }

      const selectedTag = document.getElementById('practiceTagFilter').value;
      quizMode = document.getElementById('practiceMode').value;

      if (selectedTag) {
        words = words.filter((word) => word.tags.includes(selectedTag));
        if (words.length < 2) {
          openAlertModal(
            'Add at least two words with the selected tag to start practicing.'
          );
          return;
        }
      }

      practiceWords = shuffleArray([...words]);
      currentQuestion = 0;
      score = 0;
      totalQuestions = practiceWords.length;
      quizCategoryStats = {};

      const modal = document.getElementById('quizModal');
      modal.style.display = 'flex';
      trapFocus('quizModal');
      updateQuizProgress();
      generateQuizQuestion(quizMode, selectedTag);
    }

    function closeQuizModal() {
      const modal = document.getElementById('quizModal');
      modal.style.display = 'none';
      modal.setAttribute('inert', '');
      releaseFocus();
    }

    function generateQuizQuestion(mode, selectedTag) {
      if (currentQuestion >= practiceWords.length) {
        endQuiz();
        return;
      }

      const languages = JSON.parse(localStorage.getItem('languages'));
      const word = practiceWords[currentQuestion];
      const questionElement = document.getElementById('quizQuestion');
      const answerContainer = document.getElementById('quizAnswerContainer');
      const result = document.getElementById('quizResult');

      result.innerHTML = '';
      answerContainer.innerHTML = '';

      // Track category stats
      word.tags.forEach((tag) => {
        if (!quizCategoryStats[tag]) {
          quizCategoryStats[tag] = {correct: 0, total: 0};
        }
        quizCategoryStats[tag].total += 1;
      });

      // If mode is "both," random direction
      let questionDirection = 'foreignToEnglish';
      if (mode === 'both') {
        questionDirection = Math.random() < 0.5 ? 'foreignToEnglish' : 'englishToForeign';
      }

      // MCQ or translation logic
      if ((mode === 'mcq' && questionDirection === 'foreignToEnglish') || (mode === 'both' && questionDirection === 'foreignToEnglish')) {
        questionElement.textContent = `What is the English translation of "${word.foreign}"?`;

        // Generate options
        const options = [word.english];
        const otherWords = languages[currentLanguage].words.filter(
          (w) => w.english !== word.english && (!selectedTag || w.tags.includes(selectedTag))
        );
        shuffleArray(otherWords);
        for (let i = 0; i < Math.min(3, otherWords.length); i++) {
          options.push(otherWords[i].english);
        }
        shuffleArray(options);

        options.forEach((option) => {
          const btn = document.createElement('button');
          btn.className = 'option';
          btn.textContent = option;
          btn.onclick = () => checkQuizAnswer(option === word.english, word.tags);
          answerContainer.appendChild(btn);
        });
      } else if (mode === 'translate' && questionDirection === 'foreignToEnglish') {
        questionElement.textContent = `Translate to English: "${word.foreign}"`;

        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'Your answer';
        input.id = 'quizUserAnswer';
        answerContainer.appendChild(input);

        const submitBtn = document.createElement('button');
        submitBtn.textContent = 'Submit';
        submitBtn.style.marginTop = '10px';
        submitBtn.onclick = () => {
          const userAnswer = input.value.trim().toLowerCase();
          const correctAnswer = word.english.toLowerCase();
          const isCorrect = userAnswer === correctAnswer;
          checkQuizAnswer(isCorrect, word.tags, word.english);
        };
        answerContainer.appendChild(submitBtn);
      }

      // if 'both' and direction is englishToForeign, we do MCQ for that
      if (mode === 'both' && questionDirection === 'englishToForeign') {
        questionElement.textContent = `What is the foreign translation of "${word.english}"?`;

        const options = [word.foreign];
        const otherWords = languages[currentLanguage].words.filter(
          (w) => w.foreign !== word.foreign && (!selectedTag || w.tags.includes(selectedTag))
        );
        shuffleArray(otherWords);
        for (let i = 0; i < Math.min(3, otherWords.length); i++) {
          options.push(otherWords[i].foreign);
        }
        shuffleArray(options);

        options.forEach((option) => {
          const btn = document.createElement('button');
          btn.className = 'option';
          btn.textContent = option;
          btn.onclick = () => checkQuizAnswer(option === word.foreign, word.tags);
          answerContainer.appendChild(btn);
        });
      }

      updateQuizProgress();
    }

    function checkQuizAnswer(isCorrect, tags, correctAnswer = '') {
      const result = document.getElementById('quizResult');
      if (isCorrect) {
        result.innerHTML = `<span style="color: var(--success-color);">Correct!</span>`;
        score++;
        tags.forEach((tag) => {
          quizCategoryStats[tag].correct += 1;
        });
      } else {
        if (correctAnswer) {
          result.innerHTML = `<span style="color: var(--error-color);">Wrong! Correct answer: ${correctAnswer}</span>`;
        } else {
          result.innerHTML = `<span style="color: var(--error-color);">Wrong!</span>`;
        }
      }
      currentQuestion++;
      setTimeout(() => {
        generateQuizQuestion(quizMode, document.getElementById('practiceTagFilter').value);
      }, 1500);
    }

    function updateQuizProgress() {
      const progressBar = document.getElementById('quizProgressBar');
      const progressText = document.getElementById('quizProgressText');
      const progressPercentage = (currentQuestion / totalQuestions) * 100;
      progressBar.style.width = `${progressPercentage}%`;
      progressText.textContent = `Question ${currentQuestion + 1} of ${totalQuestions}`;
    }

    function endQuiz() {
      closeQuizModal();
      const languages = JSON.parse(localStorage.getItem('languages'));
      const language = languages[currentLanguage];

      // Update overall stats
      language.stats.totalSessions += 1;
      language.stats.totalScore += score;

      // Update category-wise stats
      for (const [category, stats] of Object.entries(quizCategoryStats)) {
        if (!language.stats.categoryStats[category]) {
          language.stats.categoryStats[category] = {correct: 0, total: 0};
        }
        language.stats.categoryStats[category].correct += stats.correct;
        language.stats.categoryStats[category].total += stats.total;
      }

      // Update streak
      const now = new Date();
      if (language.stats.lastPractice) {
        const lastPracticeDate = new Date(language.stats.lastPractice);
        const diffTime = now - lastPracticeDate;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        if (diffDays === 1) {
          language.stats.streak += 1;
        } else if (diffDays > 1) {
          language.stats.streak = 1;
        }
      } else {
        language.stats.streak = 1;
      }
      language.stats.lastPractice = now.toISOString();

      // Update today's score
      language.stats.todayScore = Math.round((score / totalQuestions) * 100);

      if (!language.stats.practiceDates) {
        language.stats.practiceDates = [];
        language.stats.practiceScores = [];
      }
      language.stats.practiceDates.push(now.toLocaleString());
      language.stats.practiceScores.push(language.stats.todayScore);

      checkForBadges(language);
      localStorage.setItem('languages', JSON.stringify(languages));

      updateStats();
      openSuccessModal(
        `Quiz completed!\nYour score: ${score}/${totalQuestions} (${language.stats.todayScore}%)`
      );
    }

    // On initial load
    document.addEventListener('DOMContentLoaded', () => {
      showMainMenu();
    });
  </script>
</body>

</html>